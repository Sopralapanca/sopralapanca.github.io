(()=>{"use strict";function e(e){return e.getFullYear()+"/"+("0"+(e.getMonth()+1)).slice(-2)+"/"+("0"+e.getDate()).slice(-2)}function t(e){return e.getDate()+"."+("0"+(e.getMonth()+1)).slice(-2)+"."+e.getFullYear()}function n(e){return(e=e/60+.5|0)>=60?(0|e/60)+"h "+("0"+e%60).slice(-2)+"m":e+"m"}let l={command:"save",warningFactor:.85,autoReloadTime:12e4,oflags:4199743,sooner:5,later:5,ast:100,payrate:10,dailyWarn:0,weeklyWarn:0,monthlyWarn:0,ct:8e3,mls:"",fdw:1,crl:[["",""],["",""],["",""],["",""],["",""]]};document.getElementById("log").onclick=()=>{chrome.runtime.sendMessage({command:"openLog"})};let a=0;function o(e){e=new Date(e.setDate(e.getDate()-e.getDay()+(e.getDay()?1:-6)*l.fdw));let t=[new Date(e)];for(;e.setDate(e.getDate()+1)&&e.getDay()!=l.fdw;)t.push(new Date(e));return t}document.getElementById("lbLatMonthlyView").onclick=()=>{S("monthscreen"),a=1},document.getElementById("lbLatWeeklyView").onclick=()=>{S("weekscreen"),a=0,u()};let d,c,s={},r=[],i=[],m=[];function u(){m=r.map(e);const t=m[0].slice(0,7),n=m[6].slice(0,7);i.includes(t)&&i.includes(n)?h():(i=[t,n],chrome.runtime.sendMessage({command:"tsa",months:i},(e=>{s=e,h()})))}const g=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],y=["DB","EXP","IRR","RR","SXS","TTR","URL"];function h(){let e=Array(21).fill(0),a=0,o=0,d=0,c=l.oflags&1<<23?[]:[0,1,2,3,4,5,6],i=Array(21).fill(0);if(r.length){let u="<colgroup><col><col span=2><col span=2><col span=2><col span=2><col span=2><col span=2><col span=2><col span=2></colgroup><thead><tr><th>";for(let n=0;n<7;n++){u+='<th class=date colspan=2 title="Click to edit">'+g[n+l.fdw]+" "+t(r[n]);let y=s[m[n]];if(y)for(let t=0;t<7;t++){let l=y[2*t],s=y[14+t];l+s&&(c.includes(t)||c.push(t),i[3*n]+=l,i[3*n+1]+=s,i[3*n+2]+=y[2*t+1],e[2*t]+=l,e[14+t]+=s,e[2*t+1]+=y[2*t+1],a+=l,o+=s,d+=y[2*t+1])}}u+="<th class=totals colspan=2>TOTALS<tbody><tr class=even><td><b>TASKS</b><td>TIME<td>Tasks<td>TIME<td>Tasks<td>TIME<td>Tasks<td>TIME<td>Tasks<td>TIME<td>Tasks<td>TIME<td>Tasks<td>TIME<td>Tasks<td class=remark>TIME<td class=remark>Tasks";let h=32768&l.oflags,f=1024&l.oflags;c.sort().forEach((t=>{u+="<tr><td>"+y[t];for(let e=0;e<7;e++){let n=s[m[e]];u+=n?'<td data-aet="'+(n[f?2*t:14+t]/60).toFixed(2)+'"data-real="'+(n[14+t]/60).toFixed(2)+'"><td data-tasks="'+n[2*t+1]+'">':'<td data-aet="0.00"data-real="0.00"><td data-tasks="0">'}u+='<td class="remark"data-aet="'+(e[2*t]/60).toFixed(2)+'"data-real="'+(e[14+t]/60).toFixed(2)+'"><td class="remark"data-tasks="'+e[2*t+1]+'">'})),u+="<tr class=total><td class=totals>TOTAL";for(let e=0;e<7;e++)u+='<td data-aet="'+(h?n(i[f?3*e:3*e+1]):(i[f?3*e:3*e+1]/60).toFixed(2))+'"data-real="'+(h?n(i[3*e+1]):(i[3*e+1]/60).toFixed(2))+'"title="Earnings: '+(l.payrate*i[f?3*e:3*e+1]/3600).toFixed(2)+'"><td data-tasks="'+i[3*e+2]+'">';u+='<td data-aet="'+(h?n(f?a:o):((f?a:o)/60).toFixed(2))+'"data-real="'+(h?n(o):(o/60).toFixed(2))+'"title="Earnings: '+(l.payrate*(f?a:o)/3600).toFixed(2)+'"><td data-tasks="'+d+'">',document.getElementById("weekly").innerHTML=u,k()}else x()}let f,p;function E(){let e=p+"/"+("0"+(f+1)).slice(-2);i.includes(e)?k():chrome.runtime.sendMessage({command:"tsa",months:[e]},(t=>{s=t,i=[e],k()}))}let v,w=0;function k(){chrome.runtime.sendMessage({command:"dK"},(e=>{document.querySelectorAll("#monthly th:not(:first-child)").forEach(((e,t)=>{e.textContent=g[t+l.fdw]})),a||(m.includes(e)?(f=e.slice(5,7)-1,p=~~e.slice(0,4)):(f=r[3].getMonth(),p=r[3].getFullYear()));let t=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][f]+"-"+p;document.getElementById("monthly_month").textContent=t,w=new Date(p,f,1).getDay()-l.fdw,~w||(w=6);const o=new Date(p,f+1,0).getDate()+w-1;let i=1,u=0,h=0,E=0,v=Array(21).fill(0),k=p+"/"+("0"+(f+1)).slice(-2),I="<thead><tr><th>";for(let t=0,n=document.querySelectorAll("col:not(:first-child):not(:last-child)"),a=document.querySelectorAll(".date");t<7;t++){I+="<th>"+g[t+l.fdw];let o=m[t]==e;n[t].style.backgroundColor=o?"#FFD180":"#fff",a[t].style.fontWeight=o?"bold":"normal"}const B=["1st","2nd","3rd","4th","5th","6th"],x=e.slice(5,7)-1==f&&~~e.slice(0,4)==p?~~e.slice(8):0;I+="<tbody>";for(let e=0;e<42;e++){if(!(e%7)){if(e>o)break;I+="<tr><td>"+B[e/7]+" Week"}if(e<w||e>o)I+='<td style="background-color:#ddd">';else{I+='<td style="background-color:#f'+(x==i?"d8":"ff")+'" data-day="'+i+'" data-aet="';let e=s[k+"/"+("0"+i++).slice(-2)];if(e){let t=0,a=0,o=0;for(let n=7;n--;)v[3*n]+=e[3*n],v[3*n+1]+=e[3*n+1],v[3*n+2]+=e[3*n+2],a+=e[14+n],t+=e[2*n],o+=e[2*n+1];u+=a,h+=t,E+=o,I+=(c?n(d?t:a):((d?t:a)/3600).toFixed(2)+" h")+'" data-real="'+(c?n(a):(a/3600).toFixed(2)+" h")+'" title="Earnings: '+(l.payrate*(d?t:a)/3600).toFixed(2)+'">'}else I+=(c?'0m" data-real="0m':'0.00 h" data-real="0.00 h')+'" title="Earnings: 0.00">'}}document.querySelector("#monthly table").innerHTML=I;let D="<thead><tr><th>Month:<th id=month style=cursor:pointer colspan=2>"+t+"<tr><th>Type<th>Time<th>Tasks<tbody>";const M=l.oflags&1<<23;for(let e=0;e<7;e++)!v[2*e+1]&&M||(D+="<tr><td>"+y[e]+'<td data-aet="'+(v[d?2*e:14+e]/60).toFixed(2)+'" data-real="'+(v[14+e]/60).toFixed(2)+'"><td data-tasks="'+v[2*e+1]+'">');D+='<tr class=total><td class=totals>TOTAL<td data-aet="'+(c?n(d?h:u):((d?h:u)/60).toFixed(2))+'" data-real="'+(c?n(u):(u/60).toFixed(2))+'" title="Earnings: '+(l.payrate*(d?h:u)/3600).toFixed(2)+'"><td data-tasks="'+E+'">',document.querySelector(".mtable table").innerHTML=D}))}document.querySelector(".mtable table").onclick=e=>{e.target.matches("#month")?(S("monthscreen"),a=1):e.target.matches(".totals")&&(c=!c,h())},document.querySelector("#monthly table").onclick=e=>{let t=document.querySelectorAll("#monthly td:not(:first-child)").indexOf(e.target);~t&&(r=o(new Date(p,f,t-w+1)),a=0,u(),S("weekscreen"))},document.getElementById("wprev").onclick=()=>{r.forEach((e=>{e.setDate(e.getDate()-7)})),u()},document.getElementById("wtoday").onclick=document.getElementById("mtoday").onclick=x,document.getElementById("wnext").onclick=()=>{r.forEach((e=>{e.setDate(e.getDate()+7)})),u()},document.getElementById("mprev").onclick=()=>{--f<0&&(f=11,p--),E()},document.getElementById("mnext").onclick=()=>{++f>11&&(f=0,p++),E()};const I=document.getElementById("adate");function B(){i=[],x()}function x(){chrome.runtime.sendMessage({command:"dK"},(e=>{v=e;const t=(n=v,new Date(n.slice(0,4),n.slice(5,7)-1,n.slice(8)));var n;r=o(new Date(t)),p=t.getFullYear(),f=t.getMonth(),u()}))}I.onchange=()=>{r=o(new Date(I.value)),u()};let D="";const M=document.querySelectorAll(".editAET"),T=document.querySelectorAll(".editxtra"),b=document.querySelectorAll(".edittasks");let L;function S(e){L&&(L.style.display="none"),L=window[e],L.style.display=""}function F(e){document.getElementById(e).style.display="flex"}document.getElementById("weekly").onclick=e=>{if(e.target.matches(".date")){const n=document.querySelectorAll(".date").indexOf(e.target);D=m[n],document.getElementById("edidate").textContent=t(r[n]);let l=s[D];for(let e=7;e--;)M[e].classList.remove("error"),b[e].classList.remove("error"),T[e].classList.remove("error"),M[e].value=l?(l[2*e]/60).toFixed(2):"0.00",b[e].value=l?l[2*e+1]:0,T[e].value=l?(l[14+e]/60).toFixed(2):"0.00";document.getElementById("editing").style.display="flex"}else e.target.matches(".totals")&&(l.oflags^=32768,h())},document.getElementById("apply").onclick=()=>{let e,t=Array(21).fill(0),n=0;for(e=7;e--;)M[e].classList.toggle("error",isNaN(t[2*e]=parseFloat(M[e].value)))&&n++,b[e].classList.toggle("error",isNaN(t[2*e+1]=0|b[e].value))&&n++,T[e].classList.toggle("error",isNaN(t[14+e]=parseFloat(T[e].value)))&&n++;if(!n){for(e=7;e--;)t[2*e]=Math.round(60*t[2*e]),t[14+e]=Math.round(60*t[14+e]);chrome.runtime.sendMessage({command:"upd",name:D,data:t},(e=>{e&&"PERMISSION_DENIED"==e.code?F("warnsub"):(s[D]=t,h())})),document.getElementById("editing").style.display="none"}};const A=document.querySelectorAll(".dark");function q(){A.forEach((e=>{e.style.display="none"}))}function N(e){e.target===this&&(this.style.display="none",C.apply(this.firstChild))}function W(e){const t=this.parentNode,n=t.getBoundingClientRect(),l=e.clientX-n.left,a=e.clientY-n.top;this.onmousemove=e=>{let o=e.clientX-l,d=e.clientY-a;o+n.width>innerWidth&&(o=innerWidth-n.width),d+n.height>innerHeight&&(d=innerHeight-n.height),o<0&&(o=0),d<0&&(d=0),t.style.left=o+"px",t.style.top=d+"px"}}function C(){this.onmousemove=null}A.forEach((e=>{e.onclick=N})),document.querySelectorAll(".drag").forEach((e=>{e.onmousedown=W,e.onmouseup=e.onmouseout=C})),document.body.onkeydown=e=>{27==e.keyCode&&q()},document.querySelectorAll(".ver").forEach((e=>{e.textContent=chrome.runtime.getManifest().version})),document.getElementById("mngsub").onclick=()=>{chrome.runtime.sendMessage({command:"mngsub"})},document.getElementById("lbLatSettings").onclick=()=>{te(),F("settingsscreen")};const R=document.getElementById("mails"),O=document.getElementById("w"),H=document.getElementById("rm"),Y=document.getElementById("rs"),j=document.getElementById("sooner"),V=document.getElementById("later"),P=document.getElementById("fdw"),J=document.getElementById("ct"),U=document.getElementById("payrate"),X=document.querySelectorAll(".lcrl"),K=document.querySelectorAll(".ucrl"),$=document.getElementById("dgh"),_=document.getElementById("dgm"),z=document.getElementById("wgh"),G=document.getElementById("wgm"),Q=document.getElementById("mgh"),Z=document.getElementById("mgm"),ee=document.querySelector("span.preview");function te(){chrome.runtime.sendMessage({command:"panel"},(e=>{const t=[].findIndex;for(let t in e)l[t]=e[t];document.querySelectorAll(".notif").forEach((e=>{e.checked=l.oflags&e.value}));let n=l.autoReloadTime/1e3,a=0|n/60,o=n%60;O.value=100*l.warningFactor,j.selectedIndex=t.call(j,(e=>e.value==l.sooner)),V.selectedIndex=t.call(V,(e=>e.value==l.later)),H.selectedIndex=t.call(H,(e=>e.value==a)),Y.selectedIndex=t.call(Y,(e=>e.value==o)),P.selectedIndex=t.call(P,(e=>e.value==l.fdw)),J.selectedIndex=t.call(J,(e=>e.value==l.ct)),document.getElementById("ast").value=l.ast;for(let e=5;e--;)X[e].value=l.crl[e][0],K[e].value=l.crl[e][1];U.value=l.payrate,$.value=0|l.dailyWarn/60||"",_.value=l.dailyWarn%60,z.value=0|l.weeklyWarn/60||"",G.value=l.weeklyWarn%60,Q.value=0|l.monthlyWarn/60||"",Z.value=l.monthlyWarn%60,R.value=l.mls||"",d=1024&l.oflags,c=32768&l.oflags?1:0,le()}))}function ne(){l.warningFactor=(0|O.value)/100,l.autoReloadTime=(0|6e4*H.value)+(0|1e3*Y.value),l.sooner=0|j.value,l.later=0|V.value,l.fdw=0|P.value,l.ct=0|J.value,l.ast=0|document.getElementById("ast").value;let e=parseFloat(U.value);isNaN(e)||(l.payrate=e),l.oflags=0,document.querySelectorAll(".notif:checked").forEach((e=>{l.oflags|=e.value}));for(let e=5;e--;)l.crl[e]=[X[e].value.trim(),K[e].value.trim()];l.dailyWarn=60*$.value+~~_.value||0,l.weeklyWarn=60*z.value+~~G.value||0,l.monthlyWarn=60*Q.value+~~Z.value||0,l.mls=R.value=R.value.replace(/\s/,"").split(";").filter((e=>/^[\w.]+@[\w.]+\.\w\w\w?$/.test(e))).join(";"),d=1024&l.oflags,c=32768&l.oflags?1:0,chrome.runtime.sendMessage(l)}function le(){let e="";for(let t=0;t<5;t++)if(X[t].value&&K[t].value){let n=K[t].value.replace(/\%url/gi,"http://www.example.com/subpage1/subpage2").replace(/\%main/gi,"http://www.example.com").replace(/\%host/gi,"example.com");e+=' - <a href="'+(n.indexOf("http")?"https://www.google.com/search?q="+encodeURIComponent(n):n)+'" target=_blank>'+X[t].value+"</a>"}ee.innerHTML=e}document.querySelectorAll("#settingsscreen input:not([name=stngs]),select").forEach((e=>{e.onchange=ne})),document.querySelectorAll(".lcrl,.ucrl").forEach((e=>{e.oninput=le})),document.getElementById("lbLatExport").onclick=()=>{F("exportscreen")};let ae={};function oe(t){let n=new FileReader;n.onload=()=>{ae=/csv$/i.test(t.name)?function(t){const n=t.split("\n"),l={};return n.forEach((t=>{let n=t.split(","),a=Date.parse(n.shift());if(a=a?e(new Date(a)):"",a&&21===n.length&&!n.some(isNaN)){let e=[];for(let t=0,l=0;t<7;t++)e[2*t+1]=~~n[l++],e[2*t]=~~n[l++],e[14+t]=~~n[l++];l[a]=e}})),l}(n.result):function(e){const t={};try{let n=JSON.parse(e);for(let e in n)/^\d{4}\/\d\d\/\d\d$/.test(e)&&-1!=toString.call(n[e]).indexOf("rray")&&21==n[e].length&&!n[e].some(isNaN)&&(t[e]=n[e])}finally{return t}}(n.result),function(){const e=e=>e.slice(8)+"-"+e.slice(5,7)+"-"+e.slice(0,4),t=e=>{const t=[];for(let n=0;n<7;n++)e[2*n+1]&&t.push(e[2*n+1]+" "+y[n]);return t.join(" - ")};let n="No records found";if(Object.keys(ae).length){n="<table><tr><td><b>Date<td><b>Records";for(let l in ae)n+="<tr><td>"+e(l)+"<td>"+t(ae[l]);ce.style.display="block"}de.innerHTML=n}()},n.readAsText(t)}const de=document.querySelector(".preimp"),ce=document.querySelector("div.imp"),se=document.getElementById("dwnld");document.getElementById("doExport").onclick=()=>{chrome.runtime.sendMessage({command:"xprt"},(e=>{se.href="data:attachment/json,"+encodeURIComponent(JSON.stringify(e)),se.download="LBTimer.json",se.click(),q()}))};const re=document.getElementById("impfil");function ie(){re.value="",ae={},de.innerHTML="Choose file or drop it here",ce.style.display="none"}re.onchange=()=>{re.files.length&&oe(re.files[0])},de.addEventListener("dragenter",(e=>{de.classList.add("drop"),e.stopPropagation(),e.preventDefault()}),!1),de.addEventListener("dragleave",(e=>{de.classList.remove("drop"),e.stopPropagation(),e.preventDefault()}),!1),de.addEventListener("dragover",(e=>{e.stopPropagation(),e.preventDefault()}),!1),de.addEventListener("drop",(e=>{e.stopPropagation(),e.preventDefault(),de.classList.remove("drop"),oe(e.dataTransfer.files[0])}),!1),document.getElementById("doimp").onclick=()=>{confirm("Selected records will be overwritten. Are you sure?")&&chrome.runtime.sendMessage({command:"cre",files:ae},(()=>{ie(),q(),B()}))},document.getElementById("noimp").onclick=ie,document.getElementById("lbLatClock").onclick=()=>{chrome.runtime.sendMessage({command:"clock"})},document.getElementById("lbLatDel").onclick=()=>{F("delscreen")};const me=document.getElementById("deldate"),ue=document.getElementById("delmonth"),ge=document.getElementById("delfrom"),ye=document.getElementById("delto"),he=document.querySelectorAll("#delscreen [type=radio]");me.onchange=()=>{he[0].checked=!0},ue.onchange=()=>{he[1].checked=!0},ge.onchange=ye.onchange=()=>{he[2].checked=!0},document.getElementById("doDEL").onclick=()=>{const t=e=>{confirm("Selected records will be permanently deleted. Are you sure?")&&chrome.runtime.sendMessage({command:"del",files:e},(()=>{B(),q()}))};switch(he.findIndex((e=>e.checked))){case 0:me.value&&t([me.value.replace(/-/g,"/")]);break;case 1:ue.value&&t([ue.value.replace("-","/")]);break;case 2:let n=ge.value,l=ye.value;if(n&&l){let a=function(t,n){let l,a,o,d=e(t).slice(0,7),c=e(n).slice(0,7),s=[];const r=(e,t)=>e+"/"+("0"+t).slice(-2);if(n<t)return s;if(n==t)return[e(t)];if(d==c){if(1==t.getDate()&&n.getDate()==new Date(n.getFullYear(),n.getMonth()+1,0).getDate())return[d];for(;t<=n;t.setDate(t.getDate()+1))s.push(e(t));return s}if(1==t.getDate())s.push(d),l=t.getFullYear(),a=t.getMonth()+2,a>12&&(l++,a-=12),o=r(l,a);else{for(a=t.getMonth();t.getMonth()==a;t.setDate(t.getDate()+1))s.push(e(t));l=t.getFullYear(),a=t.getMonth()+1,o=r(l,a)}for(;o<c;)s.push(o),13==++a&&(l++,a=1),o=r(l,a);if(n.getDate()==new Date(n.getFullYear(),n.getMonth()+1,0).getDate())s.push(o);else for(t=new Date(n.getFullYear(),n.getMonth(),1);t<=n;t.setDate(t.getDate()+1))s.push(e(t));return s}(new Date(n),new Date(l));a.length&&t(a)}}},document.getElementById("lbLatHis").onclick=()=>{F("histscreen")};let fe=[];const pe=document.getElementById("histasks");function Ee(e){e&&(fe=e.filter((e=>/^https?:\/\/www\.raterhub\.com/.test(e.url))),document.getElementById("histable").innerHTML="<tr><td>Task Id<td>Local time"+fe.map((e=>"<tr><td>"+/kIds=(\d+)/i.exec(e.url)[1]+"<td>"+new Date(e.lastVisitTime).toLocaleTimeString())).join(""),pe.textContent=" Tasks acquired: "+fe.length,document.getElementById("expHist").style.display="")}const ve=document.getElementById("histdate");ve.onchange=()=>{pe.textContent=" Loading...",chrome.runtime.sendMessage({command:"history",when:ve.value},Ee)},document.getElementById("expHist").onclick=()=>{if(fe.length){let t=["Task Id,Acquisition time"];fe.forEach((e=>{t.push(""+[/kIds=(\d+)/i.exec(e.url)[1],new Date(e.lastVisitTime).toLocaleTimeString()])})),se.href="data:attachment/csv,"+encodeURIComponent(t.join("\n")),se.download=e(new Date(fe[0].lastVisitTime)).replace(/\//g,"-")+".csv",se.click(),q()}},document.getElementById("lbLatWhatsNew").onclick=()=>{F("whatsnew")},document.querySelector(".wn").innerHTML="<li>"+["Minor bug fuxes and corrections"].join("<li>"),document.getElementById("lbLatContact").onclick=()=>{F("contactscreen")},document.getElementById("sndmsg").onclick=()=>{const e=document.getElementById("msg");e.value?(document.getElementById("sndmsg").disabled=!0,chrome.runtime.sendMessage({command:"email",msg:e.value},(()=>{document.getElementById("sndmsg").disabled=!1,q()}))):(e.classList.add("err"),setTimeout((()=>{e.classList.remove("err")}),1e3))},window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),NodeList.prototype.findIndex=Array.prototype.findIndex,NodeList.prototype.indexOf=Array.prototype.indexOf,chrome.runtime.onMessage.addListener((e=>{switch(e.command){case"updatesheet":d=1024&e.of,c=32768&e.of?1:0,s[e.w]=e.d,h();break;case"refreshsheet":B();break;case"init":chrome.storage.local.get(["o","u","inv"],(e=>{chrome.storage.local.remove(["u","o"]),1==e.u?S("welcome"):(S("weekscreen"),2==e.u&&F("whatsnew")),te(),e.o&&F(e.o),e.inv&&(document.getElementById("invlnk").href=e.inv,F("warninv")),chrome.storage.onChanged.addListener((e=>{e.inv&&e.inv.newValue&&(document.getElementById("invlnk").href=e.inv.newValue,F("warninv"))})),chrome.runtime.sendMessage({command:"checksub"},(e=>{e&&e.paid&&(document.getElementById("subs").style.display="none")})),x()}));break;case"od":te(),F(e.which)}})),chrome.runtime.sendMessage({command:"panelopen"})})();